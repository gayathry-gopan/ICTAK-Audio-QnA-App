<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICT Sahayi Chatbot</title>
    <!-- Load Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chat-container::-webkit-scrollbar {
            width: 8px;
        }
        .chat-container::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background: #95b0d1;
            border-radius: 10px;
        }
        .chat-container::-webkit-scrollbar-thumb:hover {
            background: #95b0d1;
        }
    </style>
</head>
<body class="bg-blue-50 flex items-center justify-center min-h-screen p-4">

    <div class="bg-white shadow-xl rounded-2xl w-full max-w-2xl overflow-hidden flex flex-col h-[85vh]">
        <!-- Header -->
        <div class="bg-cyan-600 text-white p-4 rounded-t-2xl flex items-center justify-between shadow-md">
            <div class="flex items-center space-x-2">
                <img src="https://ictkerala.org/uploads/2024/08/cropped-LOGO_ICTAK-Small.png" alt="ICT Academy Logo" class="h-8">
                <h1 class="text-xl font-semibold tracking-wide">ICT Assistant</h1>
            </div>
            <button class="text-white">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <!-- Chat messages container -->
        <div id="chat-container" class="flex-grow p-6 overflow-y-auto space-y-4 bg-white">
            <div class="text-center text-gray-400 text-sm mb-4">
                <span id="current-date"></span>
            </div>
            <!-- Initial message from the chatbot -->
            <div class="flex items-start justify-start space-x-3">
                <div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0">
                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-full h-full text-gray-400">
                        <path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM3.751 20.105a8.25 8.25 0 0116.498 0 .75.75 0 01-.153.302l-2.072 2.072a.75.75 0 01-1.06 0l-1.03-1.03a.75.75 0 010-1.06L18 20.354v-3.415a.75.75 0 00-.75-.75h-.358a8.251 8.251 0 01-6.108-14.86.75.75 0 00-.518-.328A14.253 14.253 0 0112 2.25c.801 0 1.589.102 2.35.297l.518.134a.75.75 0 01.328.518c.074.453.111.916.111 1.396v.12a.75.75 0 01-.75.75h-2.12a.75.75 0 01-.75-.75V5.55A.75.75 0 0110.5 4.8v-.136a.75.75 0 00-.75-.75h-.12c-.48 0-.943-.037-1.396-.111a.75.75 0 00-.518.328A14.253 14.253 0 016 13.5v.136c0 .48-.037.943-.111 1.396a.75.75 0 00.328.518l.518.134a.75.75 0 01.518.328c.074.453.111.916.111 1.396V20.105zM9 13.5a3.75 3.75 0 117.5 0 3.75 3.75 0 01-7.5 0z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="bg-gray-200 text-gray-800 p-4 rounded-3xl max-w-[80%] shadow-sm">
                    Hello! I'm here to help you with any questions you have about the <b>ICT Academy of Kerala</b>. What would you like to know?
                </div>
            </div>
        </div>

        <!-- Input area -->
        <div class="p-4 bg-white border-t border-gray-200 flex items-center space-x-4 rounded-b-2xl">
            <input type="text" id="user-input" placeholder="Type your question here..." class="flex-grow p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 ease-in-out shadow-sm">
            <button id="send-btn" class="bg-cyan-600 text-white p-3 rounded-xl hover:bg-cyan-700 transition duration-200 ease-in-out shadow-md">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                    <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.917H13.5a.75.75 0 010 1.5H4.984l-2.432 7.918a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
                </svg>
            </button>
            <button id="record-btn" class="bg-red-500 text-white p-3 rounded-xl hover:bg-red-600 transition duration-200 ease-in-out shadow-md">
                <svg id="mic-icon" xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" />
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
                    <line x1="12" y1="19" x2="12" y2="23" />
                    <line x1="8" y1="23" x2="16" y2="23" />
                </svg>
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Set the current date and time
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true };
            document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', options);

            const sendButton = document.getElementById('send-btn');
            const recordButton = document.getElementById('record-btn');
            const userInput = document.getElementById('user-input');
            const chatContainer = document.getElementById('chat-container');
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            let isRecording = false;
            let speaking = false;

            // Initialize Speech Synthesis API
            const synth = window.speechSynthesis;
            const utterThis = new SpeechSynthesisUtterance();
            utterThis.onend = () => {
                speaking = false;
                recordButton.disabled = false;
                sendButton.disabled = false;
            };

            function speak(text) {
                if (synth.speaking) {
                    synth.cancel();
                }
                speaking = true;
                utterThis.text = text;
                synth.speak(utterThis);
            }

            // Function to add messages to the chat interface
            function addMessage(text, isUser = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'} mb-2 ${isUser ? 'space-x-reverse' : ''} space-x-3`;
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0">
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-full h-full ${isUser ? 'text-gray-400' : 'text-gray-400'}">
                            <path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM3.751 20.105a8.25 8.25 0 0116.498 0 .75.75 0 01-.153.302l-2.072 2.072a.75.75 0 01-1.06 0l-1.03-1.03a.75.75 0 010-1.06L18 20.354v-3.415a.75.75 0 00-.75-.75h-.358a8.251 8.251 0 01-6.108-14.86.75.75 0 00-.518-.328A14.253 14.253 0 0112 2.25c.801 0 1.589.102 2.35.297l.518.134a.75.75 0 01.328.518c.074.453.111.916.111 1.396v.12a.75.75 0 01-.75.75h-2.12a.75.75 0 01-.75-.75V5.55A.75.75 0 0110.5 4.8v-.136a.75.75 0 00-.75-.75h-.12c-.48 0-.943-.037-1.396-.111a.75.75 0 00-.518.328A14.253 14.253 0 016 13.5v.136c0 .48-.037.943-.111 1.396a.75.75 0 00.328.518l.518.134a.75.75 0 01.518.328c.074.453.111.916.111 1.396V20.105zM9 13.5a3.75 3.75 0 117.5 0 3.75 3.75 0 01-7.5 0z" clip-rule="evenodd" />
                         </svg>
                    </div>
                    <div class="p-4 rounded-3xl max-w-[80%] shadow-sm ${isUser ? 'bg-gray-100 text-gray-800' : 'bg-gray-200 text-gray-800'}">
                        ${text}
                    </div>
                `;
                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            // Function to simulate a "typing" indicator
            function addTypingIndicator() {
                const typingIndicatorDiv = document.createElement('div');
                typingIndicatorDiv.id = 'typing-indicator';
                typingIndicatorDiv.className = 'flex items-center space-x-2 p-3 bg-gray-200 rounded-xl rounded-tl-none max-w-[80%] mb-2 shadow-sm';
                typingIndicatorDiv.innerHTML = `
                    <span class="h-2 w-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: -0.3s;"></span>
                    <span class="h-2 w-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: -0.15s;"></span>
                    <span class="h-2 w-2 bg-gray-500 rounded-full animate-bounce"></span>
                `;
                chatContainer.appendChild(typingIndicatorDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            // Function to remove the "typing" indicator
            function removeTypingIndicator() {
                const indicator = document.getElementById('typing-indicator');
                if (indicator) {
                    indicator.remove();
                }
            }
            
            async function getAnswer(question) {
                // Do not proceed if the bot is currently speaking.
                if (speaking) {
                    return;
                }

                addMessage(question, true);
                userInput.value = '';
                addTypingIndicator();

                try {
                    const response = await fetch('http://127.0.0.1:5000/ask', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ question: question }),
                    });

                    // Check if the response is successful
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Network response was not ok');
                    }

                    const data = await response.json();
                    removeTypingIndicator();
                    addMessage(data.answer);
                    
                    // Add speech synthesis for the answer
                    speak(data.answer);

                } catch (error) {
                    removeTypingIndicator();
                    addMessage(`An error occurred: ${error.message}`);
                    console.error('Error:', error);
                }
            }

            // Text input event listeners
            sendButton.addEventListener('click', () => {
                const question = userInput.value.trim();
                if (question && !speaking) {
                    getAnswer(question);
                }
            });

            userInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const question = userInput.value.trim();
                    if (question && !speaking) {
                        getAnswer(question);
                    }
                }
            });
            
            // Speech recognition event listeners
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.interimResults = false;

            recognition.onstart = () => {
                isRecording = true;
                sendButton.disabled = true;
                recordButton.innerHTML = `<svg id="mic-icon" xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-pulse">
                                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" />
                                            <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
                                            <line x1="12" y1="19" x2="12" y2="23" />
                                            <line x1="8" y1="23" x2="16" y2="23" />
                                          </svg>`;
            };

            recognition.onend = () => {
                isRecording = false;
                sendButton.disabled = false;
                recordButton.innerHTML = `<svg id="mic-icon" xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" />
                                            <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
                                            <line x1="12" y1="19" x2="12" y2="23" />
                                            <line x1="8" y1="23" x2="16" y2="23" />
                                          </svg>`;
            };

            recognition.onresult = (event) => {
                const last = event.results.length - 1;
                const text = event.results[last][0].transcript;
                getAnswer(text);
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                removeTypingIndicator();
                addMessage("I'm sorry, I couldn't understand that. Please try again.");
                speak("I'm sorry, I couldn't understand that. Please try again.");
            };

            recordButton.addEventListener('click', () => {
                if (isRecording) {
                    recognition.stop();
                } else if (!speaking) {
                    recognition.start();
                }
            });

            // Handle microphone permission request
            if (!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
                recordButton.style.display = 'none';
                console.warn('Speech Recognition is not supported by your browser.');
            }
        });
    </script>
</body>
</html>
